<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Alumnos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f9;
            margin: 0;
            padding: 20px;
        }

        h2 { color: #007BFF; }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-top: 15px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th { background: #007BFF; color: white; }

        button {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        button.add { background: #28a745; color: white; margin-bottom: 10px; }
        button.edit { background: #ffc107; }
        button.delete { background: #dc3545; color: white; }
        button.close { background: #6c757d; color: white; }
        button.back { background: #6c757d; color: white; margin-bottom: 15px; }

        /* --- Modales --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            overflow-y: auto;
            padding-top: 40px;
        }

        .modal-content {
            background: #fff;
            margin: auto;
            padding: 20px;
            width: 95%;
            max-width: 700px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        input, select {
            width: 100%;
            padding: 8px;
            margin: 4px 0 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        label { font-weight: bold; }

        fieldset {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }

        legend { color: #007BFF; font-weight: bold; }

        .acciones { display: flex; gap: 8px; }

        /* --- Notificación --- */
        #notificacion {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #007BFF;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* --- Loader --- */
        #loader {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #007BFF;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <h2>Gestión de Alumnos</h2>

    <button class="back" onclick="volverDashboard()">← Volver al Dashboard</button>
    <button id="btnAbrirModal" class="add">Agregar familia (apoderado + hijos)</button>

    <table id="tablaAlumnos">
        <thead>
            <tr>
                <th>ID</th>
                <th>RUN</th>
                <th>Nombre</th>
                <th>Curso</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Modal Crear Familia -->
    <div id="modalForm" class="modal">
        <div class="modal-content">
            <h3>Registrar Apoderado y sus Alumnos</h3>
            <form id="formFamilia">
                <h4>Datos del Apoderado</h4>
                <input type="text" name="nombres_apoderado" placeholder="Nombres" required>
                <input type="text" name="apellido_uno_apoderado" placeholder="Apellido paterno" required>
                <input type="text" name="apellido_dos_apoderado" placeholder="Apellido materno">
                <input type="text" name="run_apoderado" placeholder="RUN" required>
                <input type="email" name="email_apoderado" placeholder="Correo electrónico">
                <input type="text" name="fono_apoderado" placeholder="Teléfono">

                <label><input type="checkbox" name="autorizado" checked> Autorizado</label>

                <hr>
                <h4>Hijos</h4>
                <div id="contenedorHijos"></div>
                <button type="button" id="btnAgregarHijo" class="add" style="margin-bottom:10px;">+ Agregar hijo</button>

                <div style="text-align: right;">
                    <button type="submit" class="add">Guardar familia</button>
                    <button type="button" class="close" id="cerrarModal">Cerrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar Alumno -->
    <div id="modalEditar" class="modal">
        <div class="modal-content">
            <h3>Editar Alumno</h3>
            <form id="formEditar">
                <input type="hidden" name="id">
                <label>Nombres</label>
                <input type="text" name="nombres" required>
                <label>Apellido Paterno</label>
                <input type="text" name="apellido_uno" required>
                <label>Apellido Materno</label>
                <input type="text" name="apellido_dos">
                <label>RUN</label>
                <input type="text" name="run" required>
                <label>Curso</label>
                <select name="curso_id" required></select>
                <div style="text-align:right;">
                    <button type="submit" class="add">Guardar cambios</button>
                    <button type="button" class="close" id="cerrarEditar">Cerrar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notificacion"></div>
    <div id="loader"><div class="spinner"></div></div>

    <script>
        const API_BASE_URL = localStorage.getItem("API_BASE_URL") || "http://127.0.0.1:8000";
        const token = localStorage.getItem("access_token");
        const apiKey = localStorage.getItem("SCODA_API_KEY");

        const modal = document.getElementById("modalForm");
        const modalEditar = document.getElementById("modalEditar");
        const btnAbrir = document.getElementById("btnAbrirModal");
        const btnCerrar = document.getElementById("cerrarModal");
        const btnCerrarEditar = document.getElementById("cerrarEditar");
        const form = document.getElementById("formFamilia");
        const formEditar = document.getElementById("formEditar");
        const contenedorHijos = document.getElementById("contenedorHijos");
        const btnAgregarHijo = document.getElementById("btnAgregarHijo");
        const tablaBody = document.querySelector("#tablaAlumnos tbody");
        const notificacion = document.getElementById("notificacion");
        const loader = document.getElementById("loader");

        let cursosCache = [];

        function mostrarNotificacion(mensaje, color="#007BFF") {
            notificacion.textContent = mensaje;
            notificacion.style.background = color;
            notificacion.style.display = "block";
            setTimeout(() => notificacion.style.display = "none", 2500);
        }

        function mostrarLoader(mostrar) {
            loader.style.display = mostrar ? "flex" : "none";
        }

        async function cargarCursos() {
            mostrarLoader(true);
            const res = await fetch(`${API_BASE_URL}/api/cursos`, {
                headers: { "Authorization": `Bearer ${token}`, "X-API-Key": apiKey }
            });
            cursosCache = await res.json();
            mostrarLoader(false);
        }

        async function cargarAlumnos() {
            mostrarLoader(true);
            tablaBody.innerHTML = "";
            const res = await fetch(`${API_BASE_URL}/api/alumnos`, {
                headers: { "Authorization": `Bearer ${token}`, "X-API-Key": apiKey }
            });
            const data = await res.json();
            data.forEach(a => {
                const persona = a.persona_detalle || {};
                const curso = a.curso_detalle ? a.curso_detalle.nombre : "-";
                tablaBody.innerHTML += `
                    <tr>
                        <td>${a.id}</td>
                        <td>${persona.run || "-"}</td>
                        <td>${persona.nombres || ""} ${persona.apellido_uno || ""}</td>
                        <td>${curso}</td>
                        <td class="acciones">
                            <button class="edit" onclick="abrirEditar(${a.id})">Editar</button>
                            <button class="delete" onclick="eliminarAlumno(${a.id})">Eliminar</button>
                        </td>
                    </tr>`;
            });
            mostrarLoader(false);
        }

        function crearBloqueHijo(index) {
            const div = document.createElement("div");
            div.innerHTML = `
                <fieldset>
                    <legend>Hijo ${index + 1}</legend>
                    <input type="text" name="nombres_hijo_${index}" placeholder="Nombres" required>
                    <input type="text" name="apellido_uno_hijo_${index}" placeholder="Apellido paterno" required>
                    <input type="text" name="apellido_dos_hijo_${index}" placeholder="Apellido materno">
                    <input type="text" name="run_hijo_${index}" placeholder="RUN" required>
                    <label>Curso</label>
                    <select name="curso_hijo_${index}" required>
                        <option value="">Seleccione curso...</option>
                        ${cursosCache.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('')}
                    </select>
                    <button type="button" class="delete" onclick="this.closest('fieldset').remove()">Eliminar</button>
                </fieldset>`;
            contenedorHijos.appendChild(div);
        }

        btnAgregarHijo.onclick = () => crearBloqueHijo(contenedorHijos.children.length);

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            mostrarLoader(true);
            const apoderado = {
                nombres: form.nombres_apoderado.value,
                apellido_uno: form.apellido_uno_apoderado.value,
                apellido_dos: form.apellido_dos_apoderado.value,
                run: form.run_apoderado.value,
                email: form.email_apoderado.value,
                fono: form.fono_apoderado.value
            };

            const alumnos = [];
            [...contenedorHijos.children].forEach((child, i) => {
                alumnos.push({
                    nombres: child.querySelector(`[name=nombres_hijo_${i}]`).value,
                    apellido_uno: child.querySelector(`[name=apellido_uno_hijo_${i}]`).value,
                    apellido_dos: child.querySelector(`[name=apellido_dos_hijo_${i}]`).value,
                    run: child.querySelector(`[name=run_hijo_${i}]`).value,
                    curso_id: child.querySelector(`[name=curso_hijo_${i}]`).value
                });
            });

            const payload = { apoderado, alumnos, autorizado: form.autorizado.checked };

            const res = await fetch(`${API_BASE_URL}/api/alumnos/crear-familia`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`,
                    "X-API-Key": apiKey
                },
                body: JSON.stringify(payload)
            });

            const result = await res.json();
            mostrarLoader(false);

            if (res.ok) {
                mostrarNotificacion(result.mensaje || "Familia registrada con éxito.", "#28a745");
                modal.style.display = "none";
                form.reset();
                contenedorHijos.innerHTML = "";
                await cargarAlumnos();
                crearBloqueHijo(0);
            } else {
                mostrarNotificacion(result.error || "Error al crear familia.", "#dc3545");
            }
        });

        async function abrirEditar(id) {
            mostrarLoader(true);
            const res = await fetch(`${API_BASE_URL}/api/alumnos/${id}`, {
                headers: { "Authorization": `Bearer ${token}`, "X-API-Key": apiKey }
            });
            const a = await res.json();
            mostrarLoader(false);
            const persona = a.persona_detalle;

            formEditar.id.value = a.id;
            formEditar.nombres.value = persona.nombres;
            formEditar.apellido_uno.value = persona.apellido_uno;
            formEditar.apellido_dos.value = persona.apellido_dos || "";
            formEditar.run.value = persona.run;
            formEditar.curso_id.innerHTML = cursosCache.map(c =>
                `<option value="${c.id}" ${a.curso_detalle && c.id == a.curso_detalle.id ? "selected" : ""}>${c.nombre}</option>`
            ).join('');
            modalEditar.style.display = "block";
        }

        formEditar.addEventListener("submit", async (e) => {
            e.preventDefault();
            mostrarLoader(true);
            const id = formEditar.id.value;
            const payload = { curso: formEditar.curso_id.value };

            const res = await fetch(`${API_BASE_URL}/api/alumnos/${id}`, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`,
                    "X-API-Key": apiKey
                },
                body: JSON.stringify(payload)
            });

            mostrarLoader(false);
            if (res.ok) {
                mostrarNotificacion("Alumno actualizado correctamente.", "#28a745");
                modalEditar.style.display = "none";
                await cargarAlumnos();
            } else {
                mostrarNotificacion("Error al actualizar alumno.", "#dc3545");
            }
        });

        async function eliminarAlumno(id) {
            if (!confirm("¿Seguro que deseas eliminar este alumno?")) return;
            mostrarLoader(true);
            const res = await fetch(`${API_BASE_URL}/api/alumnos/${id}`, {
                method: "DELETE",
                headers: { "Authorization": `Bearer ${token}`, "X-API-Key": apiKey }
            });
            mostrarLoader(false);
            if (res.ok) {
                mostrarNotificacion("Alumno eliminado correctamente.", "#28a745");
                await cargarAlumnos();
            } else {
                mostrarNotificacion("Error al eliminar alumno.", "#dc3545");
            }
        }

        btnAbrir.onclick = () => modal.style.display = "flex";
        btnCerrar.onclick = () => modal.style.display = "none";
        btnCerrarEditar.onclick = () => modalEditar.style.display = "none";
        window.onclick = e => {
            if (e.target === modal) modal.style.display = "none";
            if (e.target === modalEditar) modalEditar.style.display = "none";
        };

        function volverDashboard() { window.location.href = "/panel/dashboard/"; }

        document.addEventListener("DOMContentLoaded", async () => {
            await cargarCursos();
            await cargarAlumnos();
            crearBloqueHijo(0);
        });
    </script>
</body>
</html>
