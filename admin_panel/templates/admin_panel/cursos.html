<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n de Cursos</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 20px; }
        h2 { color: #007BFF; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #007BFF; color: white; }
        input[type="time"] { padding: 4px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; }
        button.add { background: #28a745; color: white; margin-bottom: 10px; }
        button.edit { background: #ffc107; }
        button.delete { background: #dc3545; color: white; }
        button.view { background: #17a2b8; color: white; }
        button.save { background: #007BFF; color: white; }
        button.back { background: #6c757d; color: white; margin-bottom: 15px; }

        .modal {
            display: none; position: fixed; z-index: 10;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 8px; width: 600px; max-height: 80vh; overflow-y: auto;
        }
        input, select {
            width: 100%; padding: 8px; margin: 8px 0;
            border: 1px solid #ccc; border-radius: 6px;
        }
        table.alumnos { width: 100%; border-collapse: collapse; margin-top: 10px; }
        table.alumnos th { background: #17a2b8; color: white; }
        table.alumnos td, table.alumnos th { border: 1px solid #ddd; padding: 6px; }
    </style>
</head>
<body>
    <h2>Gesti√≥n de Cursos</h2>

    <button class="back" onclick="volverDashboard()">‚Üê Volver al Dashboard</button>
    <button class="add" onclick="abrirModal()">+ Nuevo curso</button>

    <table id="cursos-table">
        <thead>
            <tr>
                <th>#</th>
                <th>Nombre</th>
                <th>Nivel</th>
                <th>Profesor</th>
                <th>Establecimiento</th>
                <th>Inicio</th>
                <th>T√©rmino</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Modal Crear/Editar Curso -->
    <div class="modal" id="modalCurso">
        <div class="modal-content">
            <h3 id="modalTitulo">Nuevo Curso</h3>
            <form id="cursoForm" onsubmit="guardarCurso(event)">
                <input type="hidden" id="cursoIdHidden">

                <label>Nombre:</label>
                <input type="text" id="nombre" placeholder="Ej: 4¬∞ B√°sico A" required>

                <label>Nivel:</label>
                <input type="number" id="nivel" min="1" placeholder="Ej: 4" required>

                <label>Profesor:</label>
                <select id="profesor"></select>

                <label>Establecimiento:</label>
                <select id="establecimiento" required></select>

                <button type="submit" style="background:#007BFF;color:white;">Guardar</button>
                <button type="button" onclick="cerrarModal()">Cancelar</button>
            </form>
        </div>
    </div>

    <!-- Modal Ver Alumnos -->
    <div class="modal" id="modalAlumnos">
        <div class="modal-content">
            <h3>Alumnos del Curso</h3>
            <div id="alumnosContainer"></div>
            <button style="margin-top:10px;background:#6c757d;color:white;" onclick="cerrarModalAlumnos()">Cerrar</button>
        </div>
    </div>

    <script>
        const API_BASE_URL = "{{ API_BASE_URL }}";
        const SCODA_API_KEY = "{{ SCODA_API_KEY }}";
        const ACCESS_TOKEN = "{{ ACCESS_TOKEN }}";
        const API_URL = `${API_BASE_URL}/api/cursos`;

        if (ACCESS_TOKEN && !localStorage.getItem('access_token')) {
            localStorage.setItem('access_token', ACCESS_TOKEN);
        }
        const token = localStorage.getItem('access_token');

        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : '',
                'X-API-KEY': SCODA_API_KEY
            };
        }

        // =============================
        // CARGAR SELECTS
        // =============================
        async function cargarSelects() {
            const profRes = await fetch(`${API_BASE_URL}/api/personas`, { headers: getHeaders() });
            const profesores = await profRes.json();
            const profesorSelect = document.getElementById('profesor');
            profesorSelect.innerHTML = '<option value="">Sin profesor asignado</option>';
            profesores.forEach(p => {
                profesorSelect.innerHTML += `<option value="${p.id}">${p.nombres} ${p.apellido_uno}</option>`;
            });

            const estRes = await fetch(`${API_BASE_URL}/api/establecimientos`, { headers: getHeaders() });
            const establecimientos = await estRes.json();
            const estSelect = document.getElementById('establecimiento');
            estSelect.innerHTML = '<option value="">Seleccione establecimiento</option>';
            establecimientos.forEach(e => {
                estSelect.innerHTML += `<option value="${e.id}">${e.nombre}</option>`;
            });
        }

        // =============================
        // CARGAR CURSOS
        // =============================
        async function cargarCursos() {
            try {
                const res = await fetch(API_URL, { headers: getHeaders() });
                if (!res.ok) throw new Error(`Error ${res.status}`);
                const data = await res.json();

                const tbody = document.querySelector('#cursos-table tbody');
                tbody.innerHTML = '';
                data.forEach((c, i) => {
                    const horaInicio = c.hora_inicio ? c.hora_inicio.slice(0,5) : '08:00';
                    const horaTermino = c.hora_termino ? c.hora_termino.slice(0,5) : '15:30';
                    tbody.innerHTML += `
                        <tr data-id="${c.id}">
                            <td>${i + 1}</td>
                            <td>${c.nombre}</td>
                            <td>${c.nivel}</td>
                            <td>${c.profesor_nombre || '‚Äî'}</td>
                            <td>${c.establecimiento_nombre || '‚Äî'}</td>
                            <td><input type="time" id="inicio-${c.id}" value="${horaInicio}"></td>
                            <td><input type="time" id="termino-${c.id}" value="${horaTermino}"></td>
                            <td>
                                <button class="save" onclick="actualizarHorario(${c.id})">Guardar horario</button>
                                <button class="view" onclick="verAlumnos(${c.id})">üëÅ Ver</button>
                                <button class="edit" onclick="editarCurso(${c.id})">‚úèÔ∏è</button>
                                <button class="delete" onclick="eliminarCurso(${c.id})">üóë</button>
                            </td>
                        </tr>`;
                });
            } catch (error) {
                console.error('Error al cargar cursos:', error);
                alert('No se pudieron cargar los cursos.');
            }
        }

        // =============================
        // ACTUALIZAR HORARIO
        // =============================
        async function actualizarHorario(id) {
            const hora_inicio = document.getElementById(`inicio-${id}`).value;
            const hora_termino = document.getElementById(`termino-${id}`).value;

            try {
                const res = await fetch(`${API_URL}/${id}/actualizar-horario`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({ hora_inicio, hora_termino })
                });
                const data = await res.json();
                if (res.ok) {
                    alert(`Horario actualizado: ${data.hora_inicio} - ${data.hora_termino}`);
                } else {
                    alert(data.error || 'Error al actualizar horario');
                }
            } catch (error) {
                console.error('Error al actualizar horario:', error);
                alert('Error al guardar horario.');
            }
        }

        // =============================
        // MODALES / CRUD / VER ALUMNOS
        // =============================
        function abrirModal(curso = null) {
            const modal = document.getElementById('modalCurso');
            modal.style.display = 'flex';
            document.getElementById('cursoForm').reset();
            document.getElementById('cursoIdHidden').value = curso?.id || '';
            document.getElementById('modalTitulo').textContent = curso ? 'Editar Curso' : 'Nuevo Curso';

            if (curso) {
                document.getElementById('nombre').value = curso.nombre;
                document.getElementById('nivel').value = curso.nivel;
                document.getElementById('profesor').value = curso.profesor || '';
                document.getElementById('establecimiento').value = curso.establecimiento || '';
            }
        }

        function cerrarModal() { document.getElementById('modalCurso').style.display = 'none'; }

        async function guardarCurso(e) {
            e.preventDefault();
            const id = document.getElementById('cursoIdHidden').value;
            const url = id ? `${API_URL}/${id}` : API_URL;
            const method = id ? 'PUT' : 'POST';

            const curso = {
                nombre: document.getElementById('nombre').value,
                nivel: parseInt(document.getElementById('nivel').value),
                profesor: document.getElementById('profesor').value ? parseInt(document.getElementById('profesor').value) : null,
                establecimiento: parseInt(document.getElementById('establecimiento').value)
            };

            try {
                const res = await fetch(url, { method, headers: getHeaders(), body: JSON.stringify(curso) });
                if (res.ok) {
                    alert("Curso guardado correctamente");
                    cerrarModal();
                    cargarCursos();
                } else {
                    const errData = await res.json();
                    alert("Error al guardar: " + (errData.detail || JSON.stringify(errData)));
                }
            } catch (error) {
                console.error(error);
                alert("Error general al guardar curso");
            }
        }

        async function verAlumnos(cursoId) {
            const modal = document.getElementById('modalAlumnos');
            const cont = document.getElementById('alumnosContainer');
            cont.innerHTML = '<p>Cargando alumnos...</p>';
            modal.style.display = 'flex';

            try {
                const res = await fetch(`${API_URL}/${cursoId}/alumnos`, { headers: getHeaders() });
                const data = await res.json();
                const alumnos = data.results || [];

                if (alumnos.length === 0) {
                    cont.innerHTML = '<p>Este curso a√∫n no tiene alumnos registrados.</p>';
                    return;
                }

                let tabla = `
                    <table class="alumnos">
                        <thead>
                            <tr><th>#</th><th>Nombre</th><th>RUN</th><th>Estado actual</th><th>Observaci√≥n</th></tr>
                        </thead><tbody>`;
                alumnos.forEach((a, i) => {
                    tabla += `<tr>
                        <td>${i + 1}</td>
                        <td>${a.nombre_completo}</td>
                        <td>${a.rut}</td>
                        <td>${a.estado_actual}</td>
                        <td>${a.observacion || '‚Äî'}</td>
                    </tr>`;
                });
                tabla += '</tbody></table>';
                cont.innerHTML = tabla;
            } catch (error) {
                console.error('Error al obtener alumnos:', error);
                cont.innerHTML = '<p>Error al cargar los alumnos del curso.</p>';
            }
        }

        function cerrarModalAlumnos() { document.getElementById('modalAlumnos').style.display = 'none'; }

        function eliminarCurso(id) {
            if (confirm("¬øSeguro que deseas eliminar este curso?")) {
                fetch(`${API_URL}/${id}`, { method: "DELETE", headers: getHeaders() })
                    .then(res => {
                        if (res.status === 204) {
                            alert("Curso eliminado correctamente");
                            document.querySelector(`tr[data-id='${id}']`).remove();
                        }
                    });
            }
        }

        function volverDashboard() { window.location.href = "/panel/dashboard/"; }

        window.onclick = function(e) {
            const modal1 = document.getElementById('modalCurso');
            const modal2 = document.getElementById('modalAlumnos');
            if (e.target === modal1) modal1.style.display = 'none';
            if (e.target === modal2) modal2.style.display = 'none';
        }

        // Inicial
        cargarSelects().then(cargarCursos);
    </script>
</body>
</html>
