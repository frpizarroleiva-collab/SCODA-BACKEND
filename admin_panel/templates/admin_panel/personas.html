<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Personas</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 20px; }
        h2 { color: #007BFF; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #007BFF; color: white; }
        button { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; }
        button.add { background: #28a745; color: white; margin-bottom: 10px; }
        button.edit { background: #ffc107; }
        button.delete { background: #dc3545; color: white; }
        button.back { background: #6c757d; color: white; margin-bottom: 15px; margin-right: 10px; }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 10; 
            left: 0; top: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.4); 
            justify-content: center; 
            align-items: center;
        }
        .modal-content {
            background: #fff; 
            padding: 20px; 
            border-radius: 8px; 
            width: 400px;
        }
        .modal-header { font-size: 18px; margin-bottom: 10px; color: #007BFF; }
        .close { float: right; font-size: 24px; cursor: pointer; }
        input, select {
            width: 100%;
            padding: 8px;
            margin: 6px 0;
            box-sizing: border-box;
        }
        .alert {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 6px;
            display: none;
        }
        .alert.success { background: #d4edda; color: #155724; }
        .alert.error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

    <h2>Gestión de Personas</h2>

    <div id="alerta" class="alert"></div>

    <button class="back" onclick="volverDashboard()">← Volver al Dashboard</button>
    <button class="add" onclick="abrirModal()">+ Nueva Persona</button>

    <table id="tablaPersonas">
        <thead>
            <tr>
                <th>ID</th>
                <th>RUN</th>
                <th>Nombres</th>
                <th>Apellido Paterno</th>
                <th>Apellido Materno</th>
                <th>Email</th>
                <th>Fono</th>
                <th>País</th>
                <th>Comuna</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- MODAL -->
    <div id="modalPersona" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal()">&times;</span>
            <div class="modal-header">Formulario Persona</div>

            <input type="hidden" id="personaId">

            <label>RUN:</label>
            <input type="text" id="run">

            <label>Nombres:</label>
            <input type="text" id="nombres">

            <label>Apellido Paterno:</label>
            <input type="text" id="apellido_uno">

            <label>Apellido Materno:</label>
            <input type="text" id="apellido_dos">

            <label>Fecha Nacimiento:</label>
            <input type="date" id="fecha_nacimiento">

            <label>Email:</label>
            <input type="email" id="email">

            <label>Fono:</label>
            <input type="text" id="fono">

            <label>País:</label>
            <select id="pais_nacionalidad" onchange="cargarRegiones()"></select>

            <label>Región:</label>
            <select id="region" onchange="cargarComunas()"></select>

            <label>Comuna:</label>
            <select id="comuna"></select>

            <button class="add" onclick="guardarPersona()">Guardar</button>
            <button onclick="cerrarModal()">Cancelar</button>
        </div>
    </div>

    <script>
        // =============================
        // CONFIG Y AUTENTICACIÓN
        // =============================
        const API_URL = '/api/personas';
        const API_PAISES = '/api/paises';
        const API_REGIONES = '/api/regiones';
        const API_COMUNAS = '/api/comunas';

        const ACCESS_TOKEN = localStorage.getItem('access_token') || "{{ ACCESS_TOKEN }}";
        const SCODA_API_KEY = "{{ SCODA_API_KEY }}";
        const alerta = document.getElementById('alerta');
        const modal = document.getElementById('modalPersona');

        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': ACCESS_TOKEN ? `Bearer ${ACCESS_TOKEN}` : '',
                'X-API-KEY': SCODA_API_KEY || ''
            };
        }

        // =============================
        // LISTAR PERSONAS
        // =============================
        async function listarPersonas() {
            const res = await fetch(API_URL, { headers: getHeaders() });
            const data = await res.json();
            const tbody = document.querySelector('#tablaPersonas tbody');
            tbody.innerHTML = '';

            data.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.run || ''}</td>
                    <td>${p.nombres}</td>
                    <td>${p.apellido_uno}</td>
                    <td>${p.apellido_dos || ''}</td>
                    <td>${p.email || ''}</td>
                    <td>${p.fono || ''}</td>
                    <td>${p.pais_nacionalidad_nombre || ''}</td>
                    <td>${p.comuna_nombre || ''}</td>
                    <td>
                        <button class="edit" onclick="editarPersona(${p.id})">Editar</button>
                        <button class="delete" onclick="eliminarPersona(${p.id})">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function abrirModal() {
            limpiarFormulario();
            cargarPaises();
            modal.style.display = 'flex';
        }

        function cerrarModal() {
            modal.style.display = 'none';
        }

        function limpiarFormulario() {
            document.getElementById('personaId').value = '';
            document.querySelectorAll('input, select').forEach(e => e.value = '');
        }

        async function cargarPaises() {
            const paisSelect = document.getElementById('pais_nacionalidad');
            paisSelect.innerHTML = '<option value="">Seleccione un país</option>';
            const paises = await fetch(API_PAISES, { headers: getHeaders() }).then(r => r.json());
            paises.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.nombre;
                paisSelect.appendChild(opt);
            });
        }

        async function cargarRegiones() {
            const regionSelect = document.getElementById('region');
            regionSelect.innerHTML = '<option value="">Seleccione una región</option>';
            const paisId = document.getElementById('pais_nacionalidad').value;
            if (!paisId) return;

            const regiones = await fetch(API_REGIONES, { headers: getHeaders() }).then(r => r.json());
            regiones.filter(r => r.pais === parseInt(paisId))
                    .forEach(r => {
                        const opt = document.createElement('option');
                        opt.value = r.id;
                        opt.textContent = r.nombre;
                        regionSelect.appendChild(opt);
                    });
        }

        async function cargarComunas() {
            const comunaSelect = document.getElementById('comuna');
            comunaSelect.innerHTML = '<option value="">Seleccione una comuna</option>';
            const regionId = document.getElementById('region').value;
            if (!regionId) return;

            const comunas = await fetch(API_COMUNAS, { headers: getHeaders() }).then(r => r.json());
            comunas.filter(c => c.region === parseInt(regionId))
                    .forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = c.nombre;
                        comunaSelect.appendChild(opt);
                    });
        }

        // =============================
        // GUARDAR PERSONA
        // =============================
        async function guardarPersona() {
            const id = document.getElementById('personaId').value;
            const datos = {
                run: document.getElementById('run').value || null,
                nombres: document.getElementById('nombres').value,
                apellido_uno: document.getElementById('apellido_uno').value,
                apellido_dos: document.getElementById('apellido_dos').value || null,
                fecha_nacimiento: document.getElementById('fecha_nacimiento').value || null,
                email: document.getElementById('email').value || null,
                fono: document.getElementById('fono').value || null,
                pais_nacionalidad: document.getElementById('pais_nacionalidad').value || null,
                comuna: document.getElementById('comuna').value || null
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/${id}` : API_URL;

            const res = await fetch(url, {
                method: method,
                headers: getHeaders(),
                body: JSON.stringify(datos)
            });

            if (res.ok) {
                mostrarAlerta('Persona guardada correctamente', true);
                cerrarModal();
                listarPersonas();
            } else {
                mostrarAlerta('Error al guardar la persona', false);
            }
        }

        // =============================
        // EDITAR / ELIMINAR
        // =============================
        async function editarPersona(id) {
            const res = await fetch(`${API_URL}/${id}`, { headers: getHeaders() });
            const p = await res.json();

            abrirModal();
            document.getElementById('personaId').value = p.id;
            document.getElementById('run').value = p.run || '';
            document.getElementById('nombres').value = p.nombres;
            document.getElementById('apellido_uno').value = p.apellido_uno;
            document.getElementById('apellido_dos').value = p.apellido_dos || '';
            document.getElementById('fecha_nacimiento').value = p.fecha_nacimiento || '';
            document.getElementById('email').value = p.email || '';
            document.getElementById('fono').value = p.fono || '';
            document.getElementById('pais_nacionalidad').value = p.pais_nacionalidad || '';
            await cargarRegiones();
            document.getElementById('region').value = p.region || '';
            await cargarComunas();
            document.getElementById('comuna').value = p.comuna || '';
        }

        async function eliminarPersona(id) {
            if (!confirm('¿Está seguro de eliminar esta persona?')) return;
            const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE', headers: getHeaders() });
            if (res.ok) {
                mostrarAlerta('Persona eliminada correctamente', true);
                listarPersonas();
            } else {
                mostrarAlerta('Error al eliminar la persona', false);
            }
        }
        
        function mostrarAlerta(mensaje, exito = true) {
            alerta.textContent = mensaje;
            alerta.className = `alert ${exito ? 'success' : 'error'}`;
            alerta.style.display = 'block';
            setTimeout(() => alerta.style.display = 'none', 3000);
        }

        function volverDashboard() {
            window.location.href = "/panel/dashboard/";
        }

        window.onload = listarPersonas;
    </script>
</body>
</html>
